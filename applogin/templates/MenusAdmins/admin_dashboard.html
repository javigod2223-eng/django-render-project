{% extends 'MenusAdmins/base_dashboard.html' %}

{% block title %}Panel de Administrador{% endblock %}
{% block content %}

<!-- Mensajes de Ã©xito/error con auto-hide -->
{% if messages %}
<div class="container mt-3">
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert" id="mensaje-{{ forloop.counter }}">
            <i class="fas {% if message.tags == 'success' %}fa-check-circle{% elif message.tags == 'error' %}fa-exclamation-circle{% else %}fa-info-circle{% endif %}"></i>
            {{ message }}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    {% endfor %}
</div>

<script>
    // Auto-ocultar mensajes despuÃ©s de 5 segundos
    document.addEventListener('DOMContentLoaded', function() {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(function(alert) {
            setTimeout(function() {
                // Fade out con animaciÃ³n
                alert.style.transition = 'opacity 0.5s ease-out';
                alert.style.opacity = '0';
                setTimeout(function() {
                    alert.remove();
                }, 500);
            }, 5000); // 5000ms = 5 segundos
        });
    });
</script>
{% endif %}

<center><h2>Proyectos</h2></center>
{% include 'MenusAdmins/Modales/AddProyect.html' %}
{% include 'MenusAdmins/Modales/AddRecursoHumano.html' %}

<!-- Tabla de proyectos existentes -->
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            
            <!-- Formulario de bÃºsqueda -->
            <form method="GET" action="{% url 'admin_dashboard' %}">
                <div class="input-group mb-3">
                    <input type="text" name="q" class="form-control" placeholder="Buscar proyectos...">
                    <div class="input-group-append">
                        <button type="submit" class="btn btn-primary btn-lg"><i class="fas fa-search"></i></button>
                    </div>
                </div>
            </form>

            <!-- Botones para agregar recursos -->
            <div class="row mt-4">
                <div class="col-md-4">
                    <button type="button" class="btn btn-primary btn-lg btn-block" data-toggle="modal" data-target="#AnadirProyecto">
                        <i class="fas fa-plus-circle mr-2"></i> Agregar Proyecto
                    </button>
                </div>

                <div class="col-md-4">
    <a href="{% url 'gestion_recursos_humanos' %}" class="btn btn-success btn-lg btn-block">
        <i class="fas fa-users-cog mr-2"></i> Recursos Humanos
    </a>
</div>

                <script>
                    document.addEventListener('DOMContentLoaded', function() {
                      var rolSelect = document.getElementById('id_rol');
                      if (rolSelect) {
                          for (var i = 0; i < rolSelect.options.length; i++) {
                            if (rolSelect.options[i].value === '1') {
                              rolSelect.options[i].style.display = 'none';
                            }
                          }
                      }
                    });
                </script>

                <div class="modal fade" id="AnadirRecursoHumano" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="exampleModalLabel">AÃ±adir cuenta de recurso humanos</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form method="post" action="{% url 'insertar_usuario' %}">
    {% csrf_token %}
                                {% csrf_token %}
                                {{ form_usuario.as_p }}
                                <button type="submit" class="btn btn-primary">Guardar Usuario</button>
                            </form>
                        </div>
                      </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <button type="button" class="btn btn-info btn-lg btn-block" data-toggle="modal" data-target="#AnadirRecursoMaterial">
                        <i class="fas fa-user mr-2"></i> Hola usuario: {{ request.session.usuario_nombre }}
                    </button>
                </div>
            </div>

            <!-- Tabla de proyectos paginada -->
<div class="table-responsive mt-4">
    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>Nombre Proyecto</th>
                <th>Administrador</th>
                <th>Estado</th>
                <th>Porcentaje</th>
                <th>Fecha de Inicio</th>
                <th>Fecha Final</th>
                <th>Presupuesto</th>
                <th>Costo Final</th>
                <th>Detalles</th>
            </tr>
        </thead>
        <tbody>
            {% for proyecto in proyectos %}
            <tr {% if proyecto.finalizado %}class="table-success"{% endif %}>
                <td>
                    {{ proyecto.nombre_proyecto }}
                    {% if proyecto.finalizado %}
                        <span class="badge bg-success ms-2">âœ…</span>
                    {% endif %}
                </td>
                <td>{{ proyecto.admin_proyecto_usuario.nombre_usuario }}</td>
                <td>
                    {% if proyecto.finalizado %}
                        <span class="badge bg-success">âœ… Finalizado</span>
                        <br><small class="text-muted">{{ proyecto.fecha_finalizacion|date:"d/m/Y" }}</small>
                    {% else %}
                        <span class="badge bg-info">ðŸ”„ {{ proyecto.estado }}</span>
                    {% endif %}
                </td>
                <td>
                    {% if proyecto.finalizado %}
                        <span class="badge bg-success">100%</span>
                    {% else %}
                        {{ proyecto.porcentaje }}%
                    {% endif %}
                </td>
                <td>{{ proyecto.fecha_inicio }}</td>
                <td>{{ proyecto.fecha_final }}</td>
                <td>${{ proyecto.presupuesto|floatformat:2 }}</td>
                <td>${{ proyecto.costo_final|floatformat:2 }}</td>
                <td>
                    <a href="{% url 'detalles_proyecto' proyecto.id %}" class="btn btn-info btn-sm">
                        <i class="fas fa-eye"></i> Ver Detalles
                    </a>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="9" class="text-center text-muted">No se encontraron proyectos.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- PaginaciÃ³n -->
    <nav aria-label="Page navigation example">
        <ul class="pagination justify-content-center">
            {% if proyectos.has_previous %}
            <li class="page-item"><a class="page-link" href="?page=1">&laquo;</a></li>
            <li class="page-item"><a class="page-link" href="?page={{ proyectos.previous_page_number }}">{{ proyectos.previous_page_number }}</a></li>
            {% endif %}
            
            <li class="page-item active"><a class="page-link" href="?page={{ proyectos.number }}">{{ proyectos.number }}</a></li>
            
            {% if proyectos.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ proyectos.next_page_number }}">{{ proyectos.next_page_number }}</a></li>
            <li class="page-item"><a class="page-link" href="?page={{ proyectos.paginator.num_pages }}">&raquo;</a></li>
            {% endif %}
        </ul>
    </nav>
</div>
        </div>
    </div>
</div>

<script>
    // Reabrir modal si hay errores
    {% if mostrar_modal %}
        $(document).ready(function() {
            $('#AnadirProyecto').modal('show');
        });
    {% endif %}
    
    // ValidaciÃ³n en tiempo real
    document.addEventListener('DOMContentLoaded', function() {
        const modalForm = document.querySelector('#AnadirProyecto form');
        
        if (modalForm) {
            const presupuestoInput = modalForm.querySelector('[name="presupuesto"]');
            const costoFinalInput = modalForm.querySelector('[name="costo_final"]');
            const porcentajeInput = modalForm.querySelector('[name="porcentaje"]');
            const fechaInicioInput = modalForm.querySelector('[name="fecha_inicio"]');
            const fechaFinalInput = modalForm.querySelector('[name="fecha_final"]');
            
            // Validar presupuesto
            if (presupuestoInput) {
                presupuestoInput.addEventListener('input', function() {
                    const valor = parseFloat(this.value);
                    if (isNaN(valor) || valor < 0) {
                        this.setCustomValidity('El presupuesto no puede ser negativo');
                        this.classList.add('is-invalid');
                    } else if (valor === 0) {
                        this.setCustomValidity('El presupuesto debe ser mayor a 0');
                        this.classList.add('is-invalid');
                    } else {
                        this.setCustomValidity('');
                        this.classList.remove('is-invalid');
                        this.classList.add('is-valid');
                    }
                });
            }
            
            // Validar costo final
            if (costoFinalInput) {
                costoFinalInput.addEventListener('input', function() {
                    const valor = parseFloat(this.value);
                    if (isNaN(valor) || valor < 0) {
                        this.setCustomValidity('El costo final no puede ser negativo');
                        this.classList.add('is-invalid');
                    } else {
                        this.setCustomValidity('');
                        this.classList.remove('is-invalid');
                        this.classList.add('is-valid');
                    }
                });
            }
            
            // Validar porcentaje
            if (porcentajeInput) {
                porcentajeInput.addEventListener('input', function() {
                    const valor = parseFloat(this.value);
                    if (isNaN(valor) || valor < 0 || valor > 100) {
                        this.setCustomValidity('El porcentaje debe estar entre 0 y 100');
                        this.classList.add('is-invalid');
                    } else {
                        this.setCustomValidity('');
                        this.classList.remove('is-invalid');
                        this.classList.add('is-valid');
                    }
                });
            }
            
            // Validar fechas
            if (fechaInicioInput && fechaFinalInput) {
                const validarFechas = function() {
                    const fechaInicio = fechaInicioInput.value;
                    const fechaFinal = fechaFinalInput.value;
                    const hoy = new Date().toISOString().split('T')[0];
                    
                    if (fechaInicio && fechaInicio < hoy) {
                        fechaInicioInput.setCustomValidity('La fecha de inicio no puede ser anterior a hoy');
                        fechaInicioInput.classList.add('is-invalid');
                    } else {
                        fechaInicioInput.setCustomValidity('');
                        fechaInicioInput.classList.remove('is-invalid');
                    }
                    
                    if (fechaFinal && fechaFinal < hoy) {
                        fechaFinalInput.setCustomValidity('La fecha final no puede ser anterior a hoy');
                        fechaFinalInput.classList.add('is-invalid');
                    } else if (fechaInicio && fechaFinal && fechaFinal < fechaInicio) {
                        fechaFinalInput.setCustomValidity('La fecha final debe ser posterior a la fecha de inicio');
                        fechaFinalInput.classList.add('is-invalid');
                    } else {
                        fechaFinalInput.setCustomValidity('');
                        fechaFinalInput.classList.remove('is-invalid');
                    }
                };
                
                fechaInicioInput.addEventListener('change', validarFechas);
                fechaFinalInput.addEventListener('change', validarFechas);
            }
        }
    });
</script>

{% endblock %}
