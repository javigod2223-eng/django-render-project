{% extends 'MenusAdmins/base_dashboard.html' %}

{% block title %}Detalles del Proyecto: {{ proyecto.nombre_proyecto }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4" style="max-width: 98%; padding: 0 20px;">
    <div class="row">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

        <div class="col-md-12">
        
            <style>
                .card {
                    border: 2px solid #007bff;
                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                    padding: 20px;
                    margin: 20px auto; /* Margen autom√°tico en los lados para centrar */
                    max-width: 95%; /* Ancho m√°ximo de la card */
                    background-color: #f8f9fa;
                }
                .card-header {
                    background-color: #007bff;
                    color: white;
                    padding: 15px;
                    border-radius: 5px 5px 0 0;
                }
                .card-body {
                    padding: 20px;
                }
                .btn {
                    padding: 15px 20px;
                    font-size: 16px;
                    border-radius: 5px;
                    margin-bottom: 10px;
                }
                .badge {
                    font-size: 0.85em;
                    padding: 0.4em 0.6em;
                }
    
                .table td {
                    vertical-align: middle;
                }
    
                .btn-sm {
                    padding: 0.25rem 0.5rem;
                    font-size: 0.875rem;
                }
            </style>
            <div class="card">
                <div class="card-header text-center">
                    <h2>Detalles del Proyecto: {{ proyecto.nombre_proyecto }}</h2>
                </div>
                <div class="card-body">
                    <p><strong>Administrador:</strong> {{ proyecto.admin_proyecto_usuario.nombre_usuario }}</p>
                    <p><strong>Estado:</strong> 
                        {% if proyecto.finalizado %}
                            <span class="badge bg-success">‚úÖ Finalizado</span>
                            <small class="text-muted">({{ proyecto.fecha_finalizacion|date:"d/m/Y H:i" }})</small>
                        {% else %}
                            {{ proyecto.estado }}
                        {% endif %}
                    </p>
                    <p><strong>Porcentaje:</strong> {{ proyecto.porcentaje }}</p>
                    <p><strong>Fecha de Inicio:</strong> {{ proyecto.fecha_inicio }}</p>
                    <p><strong>Fecha Final:</strong> {{ proyecto.fecha_final }}</p>
                    <p><strong>Presupuesto:</strong> {{ proyecto.presupuesto }}</p>
                    <p><strong>Costo Final:</strong> {{ proyecto.costo_final }}</p>
                    <h3>Descripcion</h3>
                    <h4>{{ proyecto.descripcion }}</h4>
                </div>
            </div>
            <div class="card mb-1">
                <div class="card-body text-center">
                    <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#modalAsignarRecursoHumano">
                        <i class="fas fa-users"></i> Asignar Recurso Humano
                    </button>
                    <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#modalAgregarRecursoMaterial">
                        <i class="fas fa-cubes"></i> Agregar Recurso Material
                    </button>
                    <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#modalAgregarTarea">
                        <i class="fas fa-tasks"></i> Agregar Tarea/Actividad
                    </button>
                    <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#modalAgregarFase">
                        <i class="fas fa-tasks"></i> Agregar Fase
                    </button>
                    <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#modalAgregarRiesgo">
                        <i class="fas fa-exclamation-triangle"></i> Agregar Riesgo
                    </button>
                    <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#modalEditarProyecto">
                        <i class="fas fa-edit"></i> Editar proyecto y presupuesto
                    </button>
                     {% if not proyecto.finalizado %}
                    <button type="button" class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#modalFinalizarProyecto">
                        <i class="fas fa-check-circle"></i> Finalizar Proyecto
                    </button>
                    {% else %}
                    <button type="button" class="btn btn-warning me-2" data-bs-toggle="modal" data-bs-target="#modalReactivarProyecto">
                        <i class="fas fa-undo"></i> Reactivar Proyecto
                    </button>
                    {% endif %}
                    <button type="button" class="btn btn-danger me-2" data-bs-toggle="modal" data-bs-target="#confirmarEliminarProyecto">
                        <i class="fas fa-trash-alt"></i> Eliminar Proyecto
                    </button>
                </div>
            </div>




<div class="card">



        <div class="accordion" id="accordionExample">

            <!-- Acorde√≥n para Riesgos -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingRiesgos">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRiesgos" aria-expanded="true" aria-controls="collapseRiesgos">
                        Riesgos
                    </button>
                </h2>
                <div id="collapseRiesgos" class="accordion-collapse collapse show" aria-labelledby="headingRiesgos" data-bs-parent="#accordionExample">
                    <div class="accordion-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Porcentaje Riesgo</th>
                                        <th>Descripci√≥n</th>
                                        <th>Plan de Mitigaci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for riesgo in riesgos %}
                                    <tr>
                                        <td>{{ riesgo.id }}</td>
                                        <td>{{ riesgo.porcentaje_riesgo }}</td>
                                        <td>{{ riesgo.descripcion_riesgo }}</td>
                                        <td>{{ riesgo.plan_mitigacion_riesgo }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="4">No se encontraron riesgos.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            <div class="pagination">
                                {% if riesgos.has_previous %}
                                <a href="?page={{ riesgos.previous_page_number }}">Anterior</a>
                                {% endif %}
                                <span>P√°gina {{ riesgos.number }} de {{ riesgos.paginator.num_pages }}</span>
                                {% if riesgos.has_next %}
                                <a href="?page={{ riesgos.next_page_number }}">Siguiente</a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
<!-- Modal Agregar Tarea -->
<div class="modal fade" id="modalAgregarTarea" tabindex="-1" aria-labelledby="modalAgregarTareaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAgregarTareaLabel">Agregar Tarea/Actividad</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- ‚úÖ Informaci√≥n del proyecto -->
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle"></i>
                    <strong>Fechas del proyecto:</strong>
                    <ul class="mb-0 mt-2">
                        <li><strong>Inicio:</strong> {{ proyecto.fecha_inicio|date:"d/m/Y" }}</li>
                        <li><strong>Fin:</strong> {{ proyecto.fecha_final|date:"d/m/Y" }}</li>
                    </ul>
                    <small class="text-muted">La fecha l√≠mite debe estar dentro de este rango.</small>
                </div>
                
                <form action="{% url 'agregar_tarea' proyecto.id %}" method="post" id="formAgregarTarea">
                    {% csrf_token %}
                    
                    <!-- Fase -->
                    <div class="mb-3">
                        <label for="{{ agregar_tarea_form.fase.id_for_label }}" class="form-label">
                            {{ agregar_tarea_form.fase.label }}
                        </label>
                        {{ agregar_tarea_form.fase }}
                        {% if agregar_tarea_form.fase.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in agregar_tarea_form.fase.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Recurso Humano -->
                    <div class="mb-3">
                        <label for="{{ agregar_tarea_form.recurso_humano.id_for_label }}" class="form-label">
                            {{ agregar_tarea_form.recurso_humano.label }}
                        </label>
                        {{ agregar_tarea_form.recurso_humano }}
                        {% if agregar_tarea_form.recurso_humano.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in agregar_tarea_form.recurso_humano.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Descripci√≥n -->
                    <div class="mb-3">
                        <label for="{{ agregar_tarea_form.descripcion.id_for_label }}" class="form-label">
                            {{ agregar_tarea_form.descripcion.label }}
                        </label>
                        {{ agregar_tarea_form.descripcion }}
                        {% if agregar_tarea_form.descripcion.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in agregar_tarea_form.descripcion.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Fecha L√≠mite -->
                    <div class="mb-3">
                        <label for="{{ agregar_tarea_form.fecha_limite.id_for_label }}" class="form-label">
                            {{ agregar_tarea_form.fecha_limite.label }}
                        </label>
                        {{ agregar_tarea_form.fecha_limite }}
                        {% if agregar_tarea_form.fecha_limite.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in agregar_tarea_form.fecha_limite.errors %}
                                    <i class="fas fa-exclamation-triangle"></i> {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <small class="form-text text-muted">
                            Debe estar entre {{ proyecto.fecha_inicio|date:"d/m/Y" }} y {{ proyecto.fecha_final|date:"d/m/Y" }}
                        </small>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar Tarea
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
            <!-- Acorde√≥n para Recursos Materiales -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingRecursosMateriales">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRecursosMateriales" aria-expanded="false" aria-controls="collapseRecursosMateriales">
                        Recursos Materiales
                    </button>
                </h2>
                <div id="collapseRecursosMateriales" class="accordion-collapse collapse" aria-labelledby="headingRecursosMateriales" data-bs-parent="#accordionExample">
                    <div class="accordion-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Nombre Recurso</th>
                                        <th>Cantidad</th>
                                        <th>Descripci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for recurso_material in recursos_materiales %}
                                    <tr>
                                        <td>{{ recurso_material.id }}</td>
                                        <td>{{ recurso_material.nombre_recurso }}</td>
                                        <td>{{ recurso_material.cantidad }}</td>
                                        <td>{{ recurso_material.descripcion }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="4">No se encontraron recursos materiales.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            <div class="pagination">
                                {% if recursos_materiales.has_previous %}
                                <a href="?page={{ recursos_materiales.previous_page_number }}">Anterior</a>
                                {% endif %}
                                <span>P√°gina {{ recursos_materiales.number }} de {{ recursos_materiales.paginator.num_pages }}</span>
                                {% if recursos_materiales.has_next %}
                                <a href="?page={{ recursos_materiales.next_page_number }}">Siguiente</a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        
            <!-- Acorde√≥n para Recursos Humanos -->
<div class="accordion-item">
    <h2 class="accordion-header" id="headingRecursosHumanos">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRecursosHumanos" aria-expanded="false" aria-controls="collapseRecursosHumanos">
            Recursos Humanos
        </button>
    </h2>
    <div id="collapseRecursosHumanos" class="accordion-collapse collapse" aria-labelledby="headingRecursosHumanos" data-bs-parent="#accordionExample">
        <div class="accordion-body">
            <div class="table-responsive">
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre Usuario</th>
                            <th>Correo</th>
                            <th>Rol</th>
                            <th>Proyectos Asignados</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for recurso_humano in recursos_humanos %}
                        <tr>
                            <td>{{ recurso_humano.id }}</td>
                            <td>
                                <i class="fas fa-user"></i> {{ recurso_humano.usuario.nombre_usuario }}
                            </td>
                            <td>{{ recurso_humano.usuario.correo }}</td>
                            <td>
                                <span class="badge bg-primary">{{ recurso_humano.usuario.rol.nombre_rol }}</span>
                            </td>
                            <td>
                                {% with proyectos_count=recurso_humano.usuario.recursos_humanos.count %}
                                    <span class="badge {% if proyectos_count >= 2 %}bg-danger{% elif proyectos_count == 1 %}bg-warning{% else %}bg-success{% endif %}">
                                        {{ proyectos_count }}/2 proyectos
                                    </span>
                                {% endwith %}
                            </td>
                            <td>
                                {% if not proyecto.finalizado %}
                                    <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#modalEliminarRecurso{{ recurso_humano.id }}">
                                        <i class="fas fa-user-times"></i> Remover
                                    </button>
                                {% else %}
                                    <button type="button" class="btn btn-secondary btn-sm" disabled>
                                        <i class="fas fa-lock"></i> Proyecto Finalizado
                                    </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center text-muted">No se encontraron recursos humanos asignados.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modales de confirmaci√≥n para eliminar recursos humanos -->
{% for recurso_humano in recursos_humanos %}
<div class="modal fade" id="modalEliminarRecurso{{ recurso_humano.id }}" tabindex="-1" role="dialog" aria-labelledby="modalEliminarRecursoLabel{{ recurso_humano.id }}" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="modalEliminarRecursoLabel{{ recurso_humano.id }}">
                    <i class="fas fa-user-times"></i> Remover Recurso Humano
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> 
                    <strong>¬øEst√°s seguro?</strong>
                </div>
                <p>
                    Est√°s a punto de remover a <strong>{{ recurso_humano.usuario.nombre_usuario }}</strong> del proyecto 
                    <strong>{{ proyecto.nombre_proyecto }}</strong>.
                </p>
                <p class="text-muted">
                    <i class="fas fa-info-circle"></i> 
                    Al removerlo, este usuario tendr√° un espacio disponible para ser asignado a otros proyectos.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <form method="POST" action="{% url 'eliminar_recurso_humano' recurso_humano.id %}" style="display: inline;">
    {% csrf_token %}
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-user-times"></i> S√≠, Remover
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}
        
            <!-- Acorde√≥n para Documentos -->
<div class="accordion-item">
    <h2 class="accordion-header" id="headingDocumentos">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDocumentos" aria-expanded="false" aria-controls="collapseDocumentos">
            Documentos
        </button>
    </h2>
    <div id="collapseDocumentos" class="accordion-collapse collapse" aria-labelledby="headingDocumentos" data-bs-parent="#accordionExample">
        <div class="accordion-body">
            <div class="table-responsive">
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Descripci√≥n</th>
                            <th>Tipo</th>
                            <th>Ver/Descargar</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for documento in documentos %}
                        <tr>
                            <td>{{ documento.id }}</td>
                            <td>{{ documento.descripcion }}</td>
                            <td>
                                {% if documento.archivo_documento %}
                                    <span class="badge bg-success">üìÑ PDF</span>
                                {% elif documento.url_documento %}
                                    <span class="badge bg-info">üîó URL</span>
                                {% else %}
                                    <span class="badge bg-secondary">Sin contenido</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if documento.archivo_documento %}
                                    <button type="button" class="btn btn-sm btn-primary" onclick="window.open('{{ documento.archivo_documento.url }}', '_blank');">
                                        <i class="fas fa-file-pdf"></i> Ver PDF
                                    </button>
                                {% elif documento.url_documento %}
                                    <button type="button" class="btn btn-sm btn-info" onclick="window.open('{{ documento.url_documento }}', '_blank');">
                                        <i class="fas fa-link"></i> Ver Enlace
                                    </button>
                                {% else %}
                                    <span class="text-muted">No disponible</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4">No se encontraron documentos.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
            <!-- Acorde√≥n para Relaci√≥n Documentos y Fases -->
        <div class="accordion-item">
    <h2 class="accordion-header" id="headingRelaciones">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRelaciones" aria-expanded="false" aria-controls="collapseRelaciones">
            Relaci√≥n Documentos y Fases
        </button>
    </h2>
    <div id="collapseRelaciones" class="accordion-collapse collapse" aria-labelledby="headingRelaciones" data-bs-parent="#accordionExample">
        <div class="accordion-body">
            <div class="table-responsive">
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>ID Documento</th>
                            <th>Descripci√≥n Documento</th>
                            <th>Tipo</th>
                            <th>Ver/Descargar</th>
                            <th>Fase</th>
                            <th>Estado Fase</th>
                            <th>Estado Entregable</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for relacion in relaciones_documento %}
                        <tr {% if relacion.concluido %}class="table-success"{% endif %}>
                            <td>{{ relacion.documento.id }}</td>
                            <td>{{ relacion.documento.descripcion }}</td>
                            <td>
                                {% if relacion.documento.archivo_documento %}
                                    <span class="badge bg-success">üìÑ PDF</span>
                                {% elif relacion.documento.url_documento %}
                                    <span class="badge bg-info">üîó URL</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if relacion.documento.archivo_documento %}
                                    <button type="button" class="btn btn-sm btn-primary" onclick="window.open('{{ relacion.documento.archivo_documento.url }}', '_blank');">
                                        <i class="fas fa-file-pdf"></i> Ver PDF
                                    </button>
                                {% elif relacion.documento.url_documento %}
                                    <button type="button" class="btn btn-sm btn-info" onclick="window.open('{{ relacion.documento.url_documento }}', '_blank');">
                                        <i class="fas fa-link"></i> Ver Enlace
                                    </button>
                                {% endif %}
                            </td>
                            <td>{{ relacion.fase.fase }}</td>
                            <td>
                                {% if relacion.fase.concluido %}
                                    <span class="badge bg-success">‚úÖ Fase Concluida</span>
                                {% else %}
                                    <span class="badge bg-warning text-dark">üîÑ Fase Activa</span>
                                {% endif %}
                            </td>
                            <td>
                                <td>
    {% if relacion.concluido %}
        <form method="POST" action="{% url 'desmarcar_entregable_concluido' relacion.id %}" style="display: inline;">
    {% csrf_token %}
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-warning" onclick="return confirm('¬øDesmarcar como concluido?');">
                <i class="fas fa-undo"></i> Desmarcar
            </button>
        </form>
    {% else %}
        <form method="POST" action="{% url 'marcar_entregable_concluido' relacion.id %}" style="display: inline;">
    {% csrf_token %}
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('¬øMarcar este entregable como concluido y aprobado?');">
                <i class="fas fa-check"></i> Aprobar
            </button>
        </form>
    {% endif %}
</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8">No se encontraron relaciones entre documentos y fases.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<!-- Acorde√≥n para Tareas/Actividades -->
<div class="accordion-item">
    <h2 class="accordion-header" id="headingTareas">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTareas" aria-expanded="false" aria-controls="collapseTareas">
            Tareas/Actividades Asignadas
        </button>
    </h2>
    <div id="collapseTareas" class="accordion-collapse collapse" aria-labelledby="headingTareas" data-bs-parent="#accordionExample">
        <div class="accordion-body">
            <div class="table-responsive">
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Descripci√≥n</th>
                            <th>Fase</th>
                            <th>Asignado a</th>
                            <th>Fecha L√≠mite</th>
                            <th>Estado</th>
                            <th>Entregable</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tarea in tareas %}
                        <tr {% if tarea.esta_vencida %}class="table-danger"{% endif %}>
                            <td>{{ tarea.id }}</td>
                            <td>{{ tarea.descripcion }}</td>
                            <td>{{ tarea.fase.fase }}</td>
                            <td>{{ tarea.recurso_humano.usuario.nombre_usuario }}</td>
                            <td>
                                {{ tarea.fecha_limite }}
                                {% if tarea.esta_vencida %}
                                    <span class="badge bg-danger">‚ö†Ô∏è Vencida</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if tarea.estado == 'Completada' %}
                                    <span class="badge bg-success">‚úÖ {{ tarea.estado }}</span>
                                {% elif tarea.estado == 'En Progreso' %}
                                    <span class="badge bg-warning">üîÑ {{ tarea.estado }}</span>
                                {% else %}
                                    <span class="badge bg-secondary">‚è≥ {{ tarea.estado }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if tarea.documento_entregable %}
                                    {% if tarea.documento_entregable.archivo_documento %}
                                        <button type="button" class="btn btn-sm btn-success" onclick="window.open('{{ tarea.documento_entregable.archivo_documento.url }}', '_blank');">
                                            <i class="fas fa-file-pdf"></i> Ver Entregable
                                        </button>
                                    {% elif tarea.documento_entregable.url_documento %}
                                        <button type="button" class="btn btn-sm btn-info" onclick="window.open('{{ tarea.documento_entregable.url_documento }}', '_blank');">
                                            <i class="fas fa-link"></i> Ver Entregable
                                        </button>
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">Sin entregable</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7">No hay tareas asignadas en este proyecto.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
            <!-- Acorde√≥n para Fases -->
<div class="accordion-item">
    <h2 class="accordion-header" id="headingFases">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFases" aria-expanded="false" aria-controls="collapseFases">
            Fases
        </button>
    </h2>
    <div id="collapseFases" class="accordion-collapse collapse" aria-labelledby="headingFases" data-bs-parent="#accordionExample">
        <div class="accordion-body">
            <div class="table-responsive">
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Fase</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for fase in fases %}
                        <tr {% if fase.concluido %}class="table-success"{% endif %}>
                            <td>{{ fase.id }}</td>
                            <td>{{ fase.fase }}</td>
                            <td>
                                {% if fase.concluido %}
                                    <span class="badge bg-success">‚úÖ Concluida</span>
                                {% else %}
                                    <span class="badge bg-warning text-dark">üîÑ Activa</span>
                                {% endif %}
                            </td>
                            <td>
                                <td>
    {% if fase.concluido %}
        <form method="POST" action="{% url 'desmarcar_fase_concluida' fase.id %}" style="display: inline;">
    {% csrf_token %}
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-warning" onclick="return confirm('¬øReactivar esta fase?');">
                <i class="fas fa-undo"></i> Reactivar
            </button>
        </form>
    {% else %}
        <form method="POST" action="{% url 'marcar_fase_concluida' fase.id %}" style="display: inline;">
    {% csrf_token %}
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('¬øMarcar esta fase como concluida?');">
                <i class="fas fa-check"></i> Concluir Fase
            </button>
        </form>
    {% endif %}
</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4">No se encontraron fases.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
            
         <!-- Modal para agregar editar proyecto -->
        <div class="modal fade" id="modalEditarProyecto" tabindex="-1" aria-labelledby="modalAsignarRecursoHumanoLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalAsignarRecursoHumanoLabel">Editar Proyecto</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <h3>Editar Proyecto</h3>
                        <form action="{% url 'editar_proyecto' proyecto.id %}" method="post">
                            {% csrf_token %}
                            {{ form.as_p }}
                            <button type="submit" class="btn btn-primary">Guardar</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

<!-- Modal de confirmaci√≥n para eliminar -->
<div class="modal fade" id="confirmarEliminarProyecto" tabindex="-1" role="dialog" aria-labelledby="confirmarEliminarLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="confirmarEliminarLabel">
                    <i class="fas fa-exclamation-triangle"></i> Confirmar Eliminaci√≥n
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p class="text-center">
                    <strong>¬øEst√°s seguro de que deseas eliminar el proyecto "{{ proyecto.nombre_proyecto }}"?</strong>
                </p>
                <p class="text-center text-danger">
                    <i class="fas fa-exclamation-circle"></i> 
                    Esta acci√≥n NO se puede deshacer. Se eliminar√°n todos los datos asociados:
                </p>
                <ul class="text-left">
                    <li>Recursos humanos y materiales</li>
                    <li>Riesgos y planes de mitigaci√≥n</li>
                    <li>Fases y documentos</li>
                    <li>Todo el historial del proyecto</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <form method="POST" action="{% url 'eliminar_proyecto' proyecto.id %}" style="display: inline;">
    {% csrf_token %}
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash-alt"></i> S√≠, Eliminar Proyecto
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
        <!-- Modales -->
        
        <!-- Modal Asignar Recurso Humano -->
         <!-- Modal Asignar Recurso Humano -->
<div class="modal fade" id="modalAsignarRecursoHumano" tabindex="-1" aria-labelledby="modalAsignarRecursoHumanoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAsignarRecursoHumanoLabel">Asignar Recurso Humano</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- ‚úÖ Mensaje de error en tiempo real -->
                <div id="mensajeDisponibilidad" class="alert" style="display: none;"></div>
                
                <form action="{% url 'asignar_recurso_humano' proyecto.id %}" method="post" id="formAsignarRecurso">
                    {% csrf_token %}
                    
                    <div class="form-group">
                        <label for="id_usuario">Usuario: <span class="text-danger">*</span></label>
                        {{ asignar_recurso_humano_form.usuario }}
                        <small class="form-text text-muted">Selecciona el recurso humano a asignar</small>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="btnAsignarRecurso" disabled>
                        <i class="fas fa-user-plus"></i> Asignar Recurso
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectUsuario = document.querySelector('#modalAsignarRecursoHumano select[name="usuario"]');
    const mensajeDiv = document.getElementById('mensajeDisponibilidad');
    const btnAsignar = document.getElementById('btnAsignarRecurso');
    const formAsignar = document.getElementById('formAsignarRecurso');
    const proyectoId = {{ proyecto.id }};
    const urlVerificar = "{% url 'verificar_disponibilidad_usuario' %}";
    
    if (selectUsuario) {
        selectUsuario.addEventListener('change', function() {
            const usuarioId = this.value;
            
            if (!usuarioId) {
                mensajeDiv.style.display = 'none';
                btnAsignar.disabled = true;
                return;
            }
            
            // Mostrar mensaje de cargando
            mensajeDiv.className = 'alert alert-info';
            mensajeDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando disponibilidad...';
            mensajeDiv.style.display = 'block';
            btnAsignar.disabled = true;
            
            // Verificar con AJAX
            fetch(urlVerificar + `?usuario_id=${usuarioId}&proyecto_id=${proyectoId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.disponible) {
                        mensajeDiv.className = 'alert alert-success';
                        mensajeDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${data.mensaje}`;
                        btnAsignar.disabled = false;
                    } else {
                        mensajeDiv.className = 'alert alert-danger';
                        mensajeDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${data.mensaje}`;
                        btnAsignar.disabled = true;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    mensajeDiv.className = 'alert alert-warning';
                    mensajeDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error al verificar disponibilidad';
                    btnAsignar.disabled = true;
                });
        });
    }
    
    // Limpiar al cerrar el modal
    $('#modalAsignarRecursoHumano').on('hidden.bs.modal', function() {
        if (selectUsuario) selectUsuario.value = '';
        mensajeDiv.style.display = 'none';
        btnAsignar.disabled = true;
    });
});
</script>
        <!-- Modal Agregar Recurso Material -->
        <div class="modal fade" id="modalAgregarRecursoMaterial" tabindex="-1" aria-labelledby="modalAgregarRecursoMaterialLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalAgregarRecursoMaterialLabel">Agregar Recurso Material</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form action="{% url 'agregar_recurso_material' proyecto.id %}" method="post">
                            {% csrf_token %}
                            {{ agregar_recurso_material_form.as_p }}
                            <button type="submit" class="btn btn-primary">Guardar</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Agregar Documento -->
        <div class="modal fade" id="modalAgregarDocumento" tabindex="-1" aria-labelledby="modalAgregarDocumentoLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalAgregarDocumentoLabel">Agregar Documento</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form action="{% url 'agregar_documento' proyecto.id %}" method="post">
                            {% csrf_token %}
                            {{ agregar_documento_form.as_p }}
                            <button type="submit" class="btn btn-primary">Guardar</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Agregar Fase -->
<!-- Modal Agregar Fase -->
<div class="modal fade" id="modalAgregarFase" tabindex="-1" aria-labelledby="modalAgregarFaseLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAgregarFaseLabel">Agregar Fase</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="{% url 'agregar_fase' proyecto.id %}" method="post" id="formAgregarFase">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="id_fase" class="form-label">Nombre de la Fase:</label>
                        <input type="text" 
                               name="fase" 
                               id="id_fase" 
                               class="form-control {% if agregar_fase_form.fase.errors %}is-invalid{% endif %}" 
                               placeholder="Ingrese el nombre de la fase"
                               value="{{ agregar_fase_form.fase.value|default:'' }}"
                               required>
                        
                        <!-- Mostrar errores si existen -->
                        {% if agregar_fase_form.fase.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in agregar_fase_form.fase.errors %}
                                    <i class="fas fa-exclamation-triangle"></i> {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <small>El nombre de la fase debe ser √∫nico dentro de este proyecto.</small>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar Fase
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
        <!-- Modal Finalizar Proyecto -->
<div class="modal fade" id="modalFinalizarProyecto" tabindex="-1" role="dialog" aria-labelledby="modalFinalizarLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modalFinalizarLabel">
                    <i class="fas fa-check-circle"></i> Finalizar Proyecto
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> <strong>¬øQu√© suceder√° al finalizar el proyecto?</strong>
                </div>
                <ul>
                    <li>El proyecto se marcar√° como <strong>"Finalizado"</strong></li>
                    <li>El porcentaje se establecer√° en <strong>100%</strong></li>
                    <li>Se <strong>liberar√°n todos los recursos humanos</strong> asignados</li>
                    <li>Los recursos humanos podr√°n ser asignados a nuevos proyectos</li>
                    <li>No se podr√°n agregar m√°s tareas, fases o recursos</li>
                    <li>El proyecto permanecer√° visible en la lista</li>
                </ul>
                <p class="text-center mt-3">
                    <strong>¬øEst√°s seguro de que deseas finalizar el proyecto "<span class="text-primary">{{ proyecto.nombre_proyecto }}</span>"?</strong>
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <form method="POST" action="{% url 'finalizar_proyecto' proyecto.id %}" style="display: inline;">
    {% csrf_token %}
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check-circle"></i> S√≠, Finalizar Proyecto
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Reactivar Proyecto -->
<div class="modal fade" id="modalReactivarProyecto" tabindex="-1" role="dialog" aria-labelledby="modalReactivarLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="modalReactivarLabel">
                    <i class="fas fa-undo"></i> Reactivar Proyecto
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-center">
                    <strong>¬øDeseas reactivar el proyecto "<span class="text-primary">{{ proyecto.nombre_proyecto }}</span>"?</strong>
                </p>
                <p class="text-muted">
                    Al reactivar el proyecto, podr√°s volver a asignar recursos humanos y continuar con las actividades.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <form method="POST" action="{% url 'reactivar_proyecto' proyecto.id %}" style="display: inline;">
    {% csrf_token %}
                    {% csrf_token %}
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-undo"></i> S√≠, Reactivar Proyecto
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
        <!-- Modal Agregar Riesgo -->
        <div class="modal fade" id="modalAgregarRiesgo" tabindex="-1" aria-labelledby="modalAgregarRiesgoLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalAgregarRiesgoLabel">Agregar Riesgo</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form action="{% url 'agregar_riesgo' proyecto.id %}" method="post">
                            {% csrf_token %}
                            {{ agregar_riesgo_form.as_p }}
                            <button type="submit" class="btn btn-primary">Guardar</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>


</div>
</div>


     

                    <!-- Puedes agregar m√°s tablas para Documentos, Fases, Riesgos, etc. -->

                </div>
            </div>
            <!-- Aqu√≠ finalizan las tablas de detalles relacionados -->
        </div>
    </div>
</div>
<script>
    // Reabrir modal si hay errores
    {% if mostrar_modal_recurso_humano %}
        document.addEventListener('DOMContentLoaded', function() {
            var modal = new bootstrap.Modal(document.getElementById('modalAsignarRecursoHumano'));
            modal.show();
        });
    {% endif %}
</script>

<!-- Script para reabrir modal si hay errores -->
<script>
    {% if mostrar_modal_fase %}
        document.addEventListener('DOMContentLoaded', function() {
            var modal = new bootstrap.Modal(document.getElementById('modalAgregarFase'));
            modal.show();
        });
    {% endif %}

    {% if mostrar_modal_tarea %}
        document.addEventListener('DOMContentLoaded', function() {
            var modal = new bootstrap.Modal(document.getElementById('modalAgregarTarea'));
            modal.show();
        });
    {% endif %}
</script>
<!-- Script para reabrir modales si hay errores -->

    
    



{% endblock %}
